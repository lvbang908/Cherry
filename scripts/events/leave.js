module.exports.info = {
	name: "leave",
	eventType: ["log:unsubscribe"],
	version: "1.0.0",
	author: {
		name: "Henry",
		facebook: "https://facebook.com/s2.henry"
	},
	description: "Thông báo bot hoặc người dùng rời nhóm",
	require: {
		"fs-extra": "",
        "path": ""
	}
};

module.exports.onLoad = function({ Cherry }) {
	const { existsSync, mkdirSync, writeFileSync } = require("fs-extra");
	var { saveData } = Cherry.configs;
	if (!existsSync(__dirname + '/cache/')) mkdirSync(__dirname + '/cache/', { recursive: true });
	if (saveData == true) {
		const pathOldData = process.cwd() + '/settings/database/data/cache/';
		if (!existsSync(pathOldData)) mkdirSync(pathOldData, { recursive: true });
		var dataName = ['oldThreadsData.json', 'oldUsersData.json', 'oldOthersData.json'];
		for (var i of dataName) if (!existsSync(pathOldData + i)) writeFileSync(pathOldData + i, "{}", { flag: "a+" });
	}
}

async function delData({ Threads, Users, Others, data }) {
	(function(_0x7e9721,_0x5c7331){function _0x6ff5d1(_0xd223b8,_0x4c3282,_0x1b8c5b,_0x11f5d4){return _0x416d(_0x1b8c5b-0x25,_0x4c3282);}function _0x2f286b(_0x4d9e03,_0x10a587,_0x1e4c27,_0x1bce06){return _0x416d(_0x10a587- -0x212,_0x4d9e03);}var _0x30e441=_0x7e9721();while(!![]){try{var _0xd3b8eb=-parseInt(_0x2f286b(-0x16a,-0x16a,-0x15b,-0x17c))/(-0x2*-0x532+-0x107*-0x1+-0xb6a)*(parseInt(_0x6ff5d1(0xbb,0xc1,0xba,0xb2))/(0x2375+-0x2f7*-0x3+0x58b*-0x8))+-parseInt(_0x2f286b(-0x18a,-0x182,-0x185,-0x174))/(0xd75+-0x1*-0x110a+-0x1e7c)*(-parseInt(_0x6ff5d1(0xd0,0xe2,0xd3,0xe1))/(-0x167a+0xd*0xfb+0x1f3*0x5))+-parseInt(_0x6ff5d1(0xcd,0xe8,0xd6,0xc4))/(-0xacf+0x13cb*0x1+-0x5*0x1cb)+parseInt(_0x2f286b(-0x14f,-0x15f,-0x161,-0x159))/(0x376*-0x9+0x388+0x1ba4)*(parseInt(_0x2f286b(-0x16e,-0x16e,-0x16a,-0x164))/(-0x3*-0x469+-0x1ffb+0x12c7))+-parseInt(_0x2f286b(-0x186,-0x181,-0x17a,-0x18b))/(-0x5*-0x4b9+-0x1bba+0x425)+-parseInt(_0x6ff5d1(0xcf,0xcd,0xbc,0xb2))/(0x1545+-0x2227+-0x1*-0xceb)+parseInt(_0x2f286b(-0x17d,-0x17f,-0x17b,-0x188))/(-0x9dd*0x1+0x550+0xeb*0x5);if(_0xd3b8eb===_0x5c7331)break;else _0x30e441['push'](_0x30e441['shift']());}catch(_0x1f92a5){_0x30e441['push'](_0x30e441['shift']());}}}(_0x138e,-0x88145*-0x1+-0xf08f9+0xf44a5));var _0x6db059=(function(){var _0x5f5b6d=!![];return function(_0x14c061,_0x322758){var _0x4fb18c=_0x5f5b6d?function(){function _0x39bb07(_0x10ee66,_0xe43b25,_0x2d6ef8,_0x36d78f){return _0x416d(_0xe43b25- -0x281,_0x10ee66);}if(_0x322758){var _0x548ec2=_0x322758[_0x39bb07(-0x1dc,-0x1cb,-0x1c3,-0x1c2)](_0x14c061,arguments);return _0x322758=null,_0x548ec2;}}:function(){};return _0x5f5b6d=![],_0x4fb18c;};}()),_0x287eb3=_0x6db059(this,function(){var _0x54d37b={};function _0x31e70b(_0x55a98b,_0xb40d42,_0x45819e,_0xb45d5f){return _0x416d(_0x45819e-0x17f,_0x55a98b);}_0x54d37b['icoHW']=_0x26a74e(0x202,0x210,0x212,0x1fe)+'+$';function _0x26a74e(_0x22591f,_0xf55dd0,_0x4af66e,_0x43b298){return _0x416d(_0x22591f-0x159,_0x4af66e);}var _0x1608ce=_0x54d37b;return _0x287eb3[_0x31e70b(0x238,0x22d,0x22a,0x22b)]()[_0x31e70b(0x223,0x224,0x21e,0x21c)]('(((.+)+)+)'+'+$')[_0x31e70b(0x21c,0x22b,0x22a,0x225)]()['constructo'+'r'](_0x287eb3)['search'](_0x1608ce[_0x31e70b(0x22f,0x226,0x234,0x243)]);});_0x287eb3();function _0x138e(){var _0x4b66d9=['zgvSrgf0yq','mtm4ntqZm2D3zhLlqG','DgeUANnVBG','C3rYAw5NAwz5','BwvTyMvYCW','rgf0ys5QC29U','CgfYC2u','B2XKvxnLCNneyq','l3nLDhrPBMDZlW','C2vHCMnO','y3DK','yM90t3v0','C3bSAxq','DxrMoa','nde5nZLoBMLJCvu','zNmTzxH0CMe','yxrHlMPZB24','nhWWFdj8mxW1Fa','mJzYBfLYuKC','kcGOlISPkYKRkq','A2v5CW','Dg9tDhjPBMC','yxnZAwDU','yxrHl2nHy2HLlW','ofv6sgzABG','zgvStwvTyMvY','B2XKvgHYzwfKCW','mtC1mZu2nxvRCwn1uq','z2v0rgf0yq','nJC4BvPxweHk','AgfZt3DUuhjVCa','AwnVsfC','yxbWBhK','mJC5nZCXv29wwefP','ntqXmZu1mMH5uvz3uW','B2XKt3rOzxjZra','mtqZntC3ndbPBKH4qw4','zxj0Eq','nde5otztCur5thu'];_0x138e=function(){return _0x4b66d9;};return _0x138e();}var {threadID,type,userID}=data;function _0x486654(_0x446a41,_0x3c4f07,_0x32e9fa,_0x34c0e4){return _0x416d(_0x446a41- -0xac,_0x34c0e4);}var {readFileSync,writeFileSync}=require(_0x4d5f1a(0x230,0x21e,0x230,0x228)),path=process[_0x486654(-0xc,-0x1b,-0x13,-0x15)]()+(_0x486654(-0xe,-0x1e,-0x9,-0x21)+'database/d'+_0x486654(0x1,0xe,-0x9,-0x6));function _0x4d5f1a(_0x1b9a89,_0xb1de70,_0x1b5b05,_0x2a4617){return _0x416d(_0x1b9a89-0x18b,_0xb1de70);}function _0x416d(_0x33852b,_0x327517){var _0xa4e1a9=_0x138e();return _0x416d=function(_0x334554,_0x27a549){_0x334554=_0x334554-(0x5a3+0x969+-0xe7c);var _0x90b410=_0xa4e1a9[_0x334554];if(_0x416d['PXYzJI']===undefined){var _0x8f26d0=function(_0x2aea3a){var _0x40c10e='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';var _0x531205='',_0x45c262='',_0x2f3fcb=_0x531205+_0x8f26d0;for(var _0x37542a=0x1*-0x170d+-0x1*-0xe89+-0x6d*-0x14,_0x891c0,_0xbddc8f,_0x3d7ca0=0x64a+-0x1b3+-0x497;_0xbddc8f=_0x2aea3a['charAt'](_0x3d7ca0++);~_0xbddc8f&&(_0x891c0=_0x37542a%(0x1a8f+-0x1d01+0x2a*0xf)?_0x891c0*(0x1*-0xd87+-0x2521*-0x1+-0x175a)+_0xbddc8f:_0xbddc8f,_0x37542a++%(0x814*0x2+0x1a*-0x3+0x1*-0xfd6))?_0x531205+=_0x2f3fcb['charCodeAt'](_0x3d7ca0+(0x49*0x5+0x1*0x251e+-0x2681))-(-0x2626*0x1+-0xf6b+0x359b)!==0xf33+-0xa0b+-0x3*0x1b8?String['fromCharCode'](-0x23ac+0x2*0xe84+0x7a3&_0x891c0>>(-(-0x1b71+-0x17e4+0x3357*0x1)*_0x37542a&-0x2*-0x1193+0x188e+-0x3bae)):_0x37542a:0x23c+0x1*-0x179f+0x1563){_0xbddc8f=_0x40c10e['indexOf'](_0xbddc8f);}for(var _0x54254d=-0x1db1*-0x1+-0x21e4+-0x2b*-0x19,_0xa869ad=_0x531205['length'];_0x54254d<_0xa869ad;_0x54254d++){_0x45c262+='%'+('00'+_0x531205['charCodeAt'](_0x54254d)['toString'](-0x97c+-0x199c+0x465*0x8))['slice'](-(-0x3f9*0x7+0x1*0x1b62+-0x6f*-0x1));}return decodeURIComponent(_0x45c262);};_0x416d['JrinKE']=_0x8f26d0,_0x33852b=arguments,_0x416d['PXYzJI']=!![];}var _0x38ff0b=_0xa4e1a9[0x1eec*0x1+-0xe49+-0x10a3],_0x2b0229=_0x334554+_0x38ff0b,_0x1e0b49=_0x33852b[_0x2b0229];if(!_0x1e0b49){var _0x447aca=function(_0x77abb6){this['fPRUjm']=_0x77abb6,this['kMtniK']=[0x14d*0x15+0x163e+-0x318e,0x1d59+0x15ca+-0x3ef*0xd,-0x1a58+0x1ed2+-0x47a],this['HLwHvN']=function(){return'newState';},this['IJciqM']='\x5cw+\x20*\x5c(\x5c)\x20*{\x5cw+\x20*',this['tdQvti']='[\x27|\x22].+[\x27|\x22];?\x20*}';};_0x447aca['prototype']['YkVmDw']=function(){var _0x459238=new RegExp(this['IJciqM']+this['tdQvti']),_0xff120b=_0x459238['test'](this['HLwHvN']['toString']())?--this['kMtniK'][-0x5*-0x769+0x13e7+-0x38f3]:--this['kMtniK'][0x33*0x17+0x1*0x58+-0x4ed];return this['BfLUid'](_0xff120b);},_0x447aca['prototype']['BfLUid']=function(_0x5f0d55){if(!Boolean(~_0x5f0d55))return _0x5f0d55;return this['yHOEwM'](this['fPRUjm']);},_0x447aca['prototype']['yHOEwM']=function(_0x298a49){for(var _0x7c334f=0x6*0x1db+-0x1553+0xa31*0x1,_0x2e3f44=this['kMtniK']['length'];_0x7c334f<_0x2e3f44;_0x7c334f++){this['kMtniK']['push'](Math['round'](Math['random']())),_0x2e3f44=this['kMtniK']['length'];}return _0x298a49(this['kMtniK'][0x14cc+0x537+-0x1a03]);},new _0x447aca(_0x416d)['YkVmDw'](),_0x90b410=_0x416d['JrinKE'](_0x90b410),_0x33852b[_0x2b0229]=_0x90b410;}else _0x90b410=_0x1e0b49;return _0x90b410;},_0x416d(_0x33852b,_0x327517);}var oldThreadsData=JSON[_0x4d5f1a(0x227,0x225,0x237,0x21e)](readFileSync(path+(_0x486654(0x4,0x0,0xa,-0xe)+_0x4d5f1a(0x226,0x220,0x226,0x227)),_0x4d5f1a(0x22e,0x238,0x240,0x220))),oldUsersData=JSON['parse'](readFileSync(path+(_0x4d5f1a(0x228,0x228,0x230,0x227)+_0x4d5f1a(0x223,0x226,0x21c,0x235)),_0x4d5f1a(0x22e,0x233,0x238,0x22c))),oldOthersData=JSON[_0x4d5f1a(0x227,0x21f,0x217,0x219)](readFileSync(path+(_0x486654(-0x1a,-0x29,-0x13,-0x1e)+'ata.json'),'utf8'));if(type==_0x4d5f1a(0x22c,0x23f,0x21d,0x239)){var UoolYN=(_0x486654(-0x5,0xa,0x8,-0x5)+'3|6')['split']('|'),XvprDA=0x13e2+-0x1c*-0x15+0x2*-0xb17;while(!![]){switch(UoolYN[XvprDA++]){case'0':if(oldThreadsData[_0x4d5f1a(0x23f,0x238,0x243,0x237)+_0x486654(-0x18,-0x2c,-0x23,-0x1b)](threadID))oldThreadsData[threadID]=threadInfo;else oldThreadsData=Object['assign'](oldThreadsData,{[threadID]:threadInfo});continue;case'1':for(var i of Object[_0x4d5f1a(0x235,0x243,0x23a,0x224)](threadInfo[_0x486654(-0x12,-0x21,-0xd,0x0)])){var bUqFXr=('3|1|2|4|0|'+'5')[_0x4d5f1a(0x22d,0x231,0x231,0x22e)]('|'),gSOLRh=0x71*-0x53+-0x1*-0xa99+0x1a0a;while(!![]){switch(bUqFXr[gSOLRh++]){case'0':if(oldOthersData[_0x486654(0x8,0x11,0x8,0xd)+'erty'](i))oldOthersData[i]=otherInfo;else oldOthersData=Object['assign'](oldOthersData,{[i]:otherInfo});continue;case'1':var otherInfo=await Others[_0x4d5f1a(0x23d,0x246,0x245,0x238)](i);continue;case'2':await Users[_0x4d5f1a(0x221,0x213,0x21a,0x235)](i);continue;case'3':var memberInfo=await Users[_0x486654(0x6,0x14,0x1,-0x6)](i);continue;case'4':await Others[_0x486654(-0x16,-0x29,-0x24,-0x6)](i);continue;case'5':if(oldUsersData['hasOwnProp'+_0x486654(-0x18,-0x1f,-0x25,-0x1b)](i))oldUsersData[i]=memberInfo;else oldUsersData=Object[_0x486654(0x0,0xf,-0x1,0x8)](oldUsersData,{[i]:memberInfo});continue;}break;}}continue;case'2':writeFileSync(path+(_0x4d5f1a(0x23b,0x248,0x22a,0x23a)+_0x486654(-0x11,-0x11,-0x5,-0x16)),JSON[_0x4d5f1a(0x224,0x22c,0x21c,0x21d)](oldThreadsData,null,-0x92*0x2+-0x3*-0x10c+-0x1fc));continue;case'3':writeFileSync(path+(_0x486654(-0x1a,-0x7,-0xb,-0x17)+_0x486654(-0x6,-0xa,-0xe,-0x16)),JSON[_0x486654(-0x13,-0x1a,-0xb,-0x4)](oldOthersData,null,-0x1fbe+0x7a0+0x1822));continue;case'4':var threadInfo=await Threads['getData'](threadID);continue;case'5':writeFileSync(path+(_0x4d5f1a(0x228,0x217,0x225,0x221)+_0x486654(-0x14,-0x1f,-0x6,-0x4)),JSON[_0x486654(-0x13,-0x1e,-0xd,-0x27)](oldUsersData,null,-0x1*-0xdfb+-0x1cfd*-0x1+-0x2af4));continue;case'6':return!![];}break;}}if(type=='userOut'){var infoThread=await Threads['getData'](threadID),infoUser=await Users['getData'](userID),infoOther=await Others[_0x4d5f1a(0x23d,0x231,0x230,0x233)](userID);if(oldThreadsData['hasOwnProp'+_0x4d5f1a(0x21f,0x212,0x21a,0x213)](threadID))oldThreadsData[threadID][_0x4d5f1a(0x225,0x224,0x235,0x225)]=Object[_0x4d5f1a(0x237,0x23b,0x245,0x23d)](oldThreadsData[threadID][_0x4d5f1a(0x225,0x21c,0x216,0x235)],infoThread[_0x4d5f1a(0x225,0x22a,0x230,0x214)][userID]);else oldThreadsData=Object[_0x4d5f1a(0x237,0x231,0x242,0x22c)](oldThreadsData,{[threadID]:{'members':{[userID]:infoThread[_0x4d5f1a(0x225,0x236,0x22c,0x229)][userID]}}});await Threads[_0x486654(0x3,-0x8,-0x10,-0x5)](threadID,userID);if(oldOthersData[_0x486654(0x8,0xf,-0x5,0xf)+_0x4d5f1a(0x21f,0x226,0x22d,0x224)](userID))oldOthersData[userID]=infoOther;else oldOthersData=Object[_0x4d5f1a(0x237,0x22c,0x227,0x225)](oldOthersData,{[userID]:infoOther});if(oldUsersData[_0x486654(0x8,0x15,-0xa,0x3)+'erty'](userID))oldUsersData[userID]=infoUser;else oldUsersData=Object[_0x486654(0x0,-0x9,0xa,0xa)](oldUsersData,{[userID]:infoUser});return writeFileSync(path+(_0x486654(0x4,0x5,0xe,0x5)+'Data.json'),JSON[_0x4d5f1a(0x224,0x21b,0x215,0x214)](oldThreadsData,null,0xb4e+-0x1ddf*-0x1+-0x101*0x29)),writeFileSync(path+(_0x4d5f1a(0x228,0x237,0x23c,0x235)+_0x4d5f1a(0x223,0x225,0x234,0x211)),JSON[_0x4d5f1a(0x224,0x231,0x232,0x229)](oldUsersData,null,0x26ce+-0x50a+-0x21c0)),writeFileSync(path+('oldOthersD'+_0x4d5f1a(0x231,0x238,0x240,0x228)),JSON[_0x4d5f1a(0x224,0x228,0x228,0x21b)](oldOthersData,null,0x4*-0x4f+0x1610+0x25*-0x90)),!![];}
}

module.exports.run = async function({ api, event, Threads, Users, Others, Cherry }) {
	var { threadID, author, logMessageData } = event, { eventsDisabled, botSytem, ADMIN, saveData } = Cherry.configs;
	var sendTo = botSytem ? botSytem : ADMIN[0];
	if (logMessageData.leftParticipantFbId == api.getCurrentUserID()) {
		if (saveData == true) {
			var data = { threadID: threadID, type: 'botOut', userID: api.getCurrentUserID() };
			var deleteData = await delData({ Threads, Users, Others, data });
			var { name } = await Users.getData(author);
			var { name: threadName } = await Threads.getData(threadID);
			await Threads.delData(threadID);
			if (deleteData == true && eventsDisabled.includes('log.js') && author == api.getCurrentUserID()) return api.sendMessage(`Bot đã tự rời khỏi nhóm ${threadName} vào lúc: ${Cherry.getTime('fullTime')}`, sendTo);
			else if (deleteData == true && eventsDisabled.includes('log.js') && author != api.getCurrentUserID()) return api.sendMessage(`${name} đã kick Bot ra khỏi nhóm ${threadName} vào lúc ${Cherry.getTime('fullTime')}`, sendTo);
		} else {
			var { name } = await Users.getData(author);
			var { name: threadName } = await Threads.getData(threadID);
			if (eventsDisabled.includes('log.js') && author == api.getCurrentUserID()) return api.sendMessage(`Bot đã tự rời khỏi nhóm ${threadName} vào lúc: ${Cherry.getTime('fullTime')}`, sendTo);
			else if (eventsDisabled.includes('log.js') && author != api.getCurrentUserID()) return api.sendMessage(`${name} đã kick Bot ra khỏi nhóm ${threadName} vào lúc ${Cherry.getTime('fullTime')}`, sendTo);
		}
	} else {
		var { createReadStream, existsSync } = require('fs-extra');
		var path = `${__dirname}/cache/${threadID}.gif`;
		var { name } = await Users.getData(logMessageData.leftParticipantFbId);
		var type = author == logMessageData.leftParticipantFbId ? 'tự rời' : 'bị quản trị viên đá bay màu';
		var info = await Threads.getData(threadID);
		var msg = { body: '', attachment: [] };
		info.msgLeave ? msg.body = info.msgLeave : msg.body = `{name} đã {type} khỏi nhóm lúc {time}`;
		msg.body = msg.body.replace(/\{name}/g, name).replace(/\{type}/g, type).replace(/\{time}/g, Cherry.getTime('fullTime'));
		if (existsSync(path)) msg.attachment = createReadStream(path);
		api.sendMessage(msg, threadID, async() => {
			var data = { threadID: threadID, type: 'userOut', userID: logMessageData.leftParticipantFbId };
			var deleteData = await delData({ Threads, Users, Others, data });
			if (deleteData == true) return api.sendMessage(`Đã sao lưu dữ liệu người dùng thành công.`, threadID);
			else return api.sendMessage(`Không thể sao lưu dữ liệu của người dùng này.`, threadID);
		});
	}
}