module.exports.info = {
	name: "welcome",
	eventType: ["log:subscribe"],
	version: "1.0.2",
	author: {
		name: "Henry",
		facebook: "https://facebook.com/s2.henry"
	},
	description: "Thông báo bot hoặc người vào nhóm",
	require: {
		"fs-extra": ""
	}
};

async function checkData(data) {
	function _0x335d(){var _0x25d2d6=['ata.json','search','users','utf8','ta.json','hasOwnProp','oldUsersDa','erty','50888QghfVZ','oldOthersD','apply','/settings/','constructo','oldThreads','10700325XLTduD','155RXUrBL','Data.json','2195571gxDgAR','(((.+)+)+)','6936036JouPlh','3504510WPDwhC','toString','parse','hcMCj','885237rvYVUZ','8WnCtOD','2SrYmJm','fs-extra','database/d','1230210FxNIof'];_0x335d=function(){return _0x25d2d6;};return _0x335d();}(function(_0x16e93b,_0x32c6d1){function _0x48ff94(_0x53bcf1,_0x5c0a0d,_0x3dce59,_0x5eb0e2){return _0x435e(_0x5c0a0d- -0x106,_0x5eb0e2);}function _0x190c45(_0x569148,_0x469869,_0x195290,_0x397e93){return _0x435e(_0x195290- -0x22e,_0x469869);}var _0x3e94e5=_0x16e93b();while(!![]){try{var _0x540e06=parseInt(_0x190c45(-0x92,-0x90,-0x91,-0x95))/(-0xb*0x85+0x2f*0xae+-0x1a3a)*(-parseInt(_0x48ff94(0x9e,0x99,0x93,0xa2))/(-0x1*-0x1a2c+-0x1b2b+0x101))+-parseInt(_0x48ff94(0xa9,0x9c,0x92,0x99))/(-0x43*0x67+-0x65d+-0x35*-0xa1)+parseInt(_0x190c45(-0xa4,-0xad,-0xa1,-0x9e))/(0x2*0x9fe+-0xdac+-0x64c)*(-parseInt(_0x48ff94(0x8f,0x8e,0x93,0x82))/(-0x1182+-0x9e6+0x1b6d))+parseInt(_0x48ff94(0x98,0x92,0x9b,0x8f))/(0x1ace+0x43b+-0x1f03)+parseInt(_0x48ff94(0x8c,0x90,0x8e,0x86))/(-0x1cc0+0x1*-0x1281+0x2f48)*(parseInt(_0x48ff94(0x97,0x98,0xa6,0x89))/(-0x2*0xffb+-0x185e+0x385c))+parseInt(_0x48ff94(0x9a,0x8d,0x8e,0x96))/(0x67c+0xdf5+0x28d*-0x8)+-parseInt(_0x48ff94(0x99,0x93,0x85,0x90))/(0x4*-0x949+0x13c0+0x116e);if(_0x540e06===_0x32c6d1)break;else _0x3e94e5['push'](_0x3e94e5['shift']());}catch(_0x17a6ed){_0x3e94e5['push'](_0x3e94e5['shift']());}}}(_0x335d,0x176*-0x3e3+0x8645b+0x6b913));var _0x50a3a5=(function(){var _0x59a204=!![];return function(_0x4aa259,_0x72c201){var _0x35a4f8=_0x59a204?function(){function _0x592184(_0x5ef239,_0x395f8c,_0x2fea07,_0xdcdbf3){return _0x435e(_0x395f8c-0x1c9,_0x2fea07);}if(_0x72c201){var _0x157427=_0x72c201[_0x592184(0x353,0x358,0x358,0x359)](_0x4aa259,arguments);return _0x72c201=null,_0x157427;}}:function(){};return _0x59a204=![],_0x35a4f8;};}()),_0x4af209=_0x50a3a5(this,function(){function _0x1c6338(_0x5a22b4,_0x4343b1,_0x4549dd,_0x31aaf6){return _0x435e(_0x31aaf6- -0xbc,_0x4549dd);}var _0x2bdffc={};_0x2bdffc[_0x1c6338(0xd5,0xed,0xd5,0xe0)]=_0x3f675e(0x2a1,0x2ab,0x2b1,0x2b4)+'+$';var _0x49e272=_0x2bdffc;function _0x3f675e(_0x5e0f1b,_0x45afdd,_0x1edca2,_0x29df91){return _0x435e(_0x45afdd-0x114,_0x29df91);}return _0x4af209[_0x3f675e(0x2a9,0x2ae,0x2a5,0x2ab)]()[_0x3f675e(0x28c,0x29a,0x2a2,0x2a4)](_0x49e272[_0x1c6338(0xe2,0xee,0xed,0xe0)])[_0x3f675e(0x2b0,0x2ae,0x2b9,0x2b0)]()[_0x1c6338(0xd8,0xcb,0xdd,0xd5)+'r'](_0x4af209)[_0x3f675e(0x2a9,0x29a,0x2a7,0x2a6)](_0x49e272[_0x3f675e(0x2b6,0x2b0,0x2a3,0x2a8)]);});_0x4af209();var {readFileSync}=require(_0x90a209(-0xab,-0xb8,-0xa9,-0xbc));function _0x5f3f91(_0x3de0ef,_0x375609,_0x2d72dc,_0x2b87c1){return _0x435e(_0x375609-0x291,_0x3de0ef);}function _0x435e(_0x2f25b7,_0x26487f){var _0xef7f8b=_0x335d();return _0x435e=function(_0x37c4f2,_0x207665){_0x37c4f2=_0x37c4f2-(0x671+0x1e6*0x9+-0x1601*0x1);var _0x31cb59=_0xef7f8b[_0x37c4f2];return _0x31cb59;},_0x435e(_0x2f25b7,_0x26487f);}var path=process['cwd']()+(_0x5f3f91(0x416,0x421,0x41a,0x430)+_0x5f3f91(0x440,0x432,0x42f,0x43d)+'ata/cache/');function _0x90a209(_0x1cfdad,_0x1df5bd,_0xee46ce,_0xe56d9d){return _0x435e(_0x1df5bd- -0x258,_0x1cfdad);}var oldThreadsData=JSON[_0x90a209(-0xb6,-0xbd,-0xc5,-0xae)](readFileSync(path+(_0x5f3f91(0x421,0x423,0x427,0x429)+_0x90a209(-0xc4,-0xc3,-0xc2,-0xb4)),_0x90a209(-0xd5,-0xd0,-0xd8,-0xdc))),oldUsersData=JSON[_0x90a209(-0xbf,-0xbd,-0xca,-0xae)](readFileSync(path+(_0x90a209(-0xbe,-0xcd,-0xc6,-0xcf)+_0x90a209(-0xcc,-0xcf,-0xc6,-0xcb)),_0x90a209(-0xcd,-0xd0,-0xc2,-0xc3))),oldOthersData=JSON['parse'](readFileSync(path+(_0x90a209(-0xd4,-0xca,-0xbe,-0xbb)+_0x90a209(-0xad,-0xb5,-0xc0,-0xbe)),_0x5f3f91(0x416,0x419,0x424,0x41c))),{type,threadID,userID}=data;if(type=='threads'){if(oldThreadsData[_0x5f3f91(0x41c,0x41b,0x425,0x413)+_0x90a209(-0xc4,-0xcc,-0xd3,-0xbd)](threadID))return!![];}if(type==_0x5f3f91(0x41c,0x418,0x422,0x415)){if(oldUsersData[_0x5f3f91(0x426,0x41b,0x41b,0x424)+_0x90a209(-0xda,-0xcc,-0xc8,-0xca)](userID)&&oldOthersData[_0x5f3f91(0x41f,0x41b,0x416,0x41b)+_0x90a209(-0xd4,-0xcc,-0xd1,-0xc0)](userID))return!![];}return![];
}

async function restoreData(data, Threads, Users, Others) {
	(function(_0x258f80,_0xdc8fec){function _0x1966fc(_0x450477,_0x4ce4e2,_0x5786cc,_0x171781){return _0x51c2(_0x5786cc-0x1df,_0x171781);}function _0x18c4e8(_0x514cab,_0x22b7cf,_0xe162e6,_0xa7c733){return _0x51c2(_0xe162e6- -0x33,_0x514cab);}var _0x44be3d=_0x258f80();while(!![]){try{var _0x29c458=-parseInt(_0x18c4e8(0xf5,0xe3,0xeb,0xec))/(-0x17b7*-0x1+0x1d80+-0x3536)*(parseInt(_0x1966fc(0x303,0x312,0x314,0x312))/(-0x1468+-0x1d*-0x9d+0x2a1))+-parseInt(_0x18c4e8(0x108,0x104,0x105,0xfc))/(-0x3*0xc1+-0x1*0xdb7+0xffd*0x1)*(parseInt(_0x1966fc(0x30f,0x305,0x316,0x311))/(0x77*-0x3d+0xa5d*-0x1+-0x10c*-0x25))+-parseInt(_0x18c4e8(0xed,0xf4,0xe7,0xe4))/(-0x2c*-0x1a+0xebc+-0x665*0x3)*(parseInt(_0x1966fc(0x312,0x314,0x30f,0x301))/(-0x893*0x4+0x19d7+0x87b))+-parseInt(_0x1966fc(0x2f6,0x307,0x305,0x301))/(0x11*0x103+0x39a*-0x9+0x1*0xf3e)+-parseInt(_0x1966fc(0x2ff,0x30e,0x2ff,0x2f3))/(0xede+0x48a+-0x136*0x10)+-parseInt(_0x18c4e8(0xf5,0xde,0xea,0xf6))/(0x71*-0x43+0xf8+0x9c*0x2f)*(-parseInt(_0x18c4e8(0x101,0x106,0x108,0x10c))/(-0xc06+-0xd*0xf7+0x189b))+parseInt(_0x1966fc(0x300,0x2eb,0x2fa,0x2fd))/(0x1171+-0x1*0x1fa5+0x1*0xe3f);if(_0x29c458===_0xdc8fec)break;else _0x44be3d['push'](_0x44be3d['shift']());}catch(_0x2d14d4){_0x44be3d['push'](_0x44be3d['shift']());}}}(_0x268a,-0x12f5+-0x5*-0x20d2f+0xd508));var {readFileSync,writeFileSync}=require(_0x49a405(0x370,0x370,0x375,0x379));function _0x49a405(_0x2ad217,_0x36a5c3,_0x23a5aa,_0x865e9e){return _0x51c2(_0x865e9e-0x243,_0x23a5aa);}function _0x51c2(_0x51c29c,_0x5de10f){var _0xc061c8=_0x268a();return _0x51c2=function(_0x347bd4,_0x26fcc1){_0x347bd4=_0x347bd4-(0x265d+-0x257c+-0x1*-0x39);var _0x532e2c=_0xc061c8[_0x347bd4];return _0x532e2c;},_0x51c2(_0x51c29c,_0x5de10f);}var path=process['cwd']()+(_0x5da20e(-0x17,-0x1c,-0x17,-0xf)+'database/d'+_0x5da20e(-0x5,-0xd,0x0,-0x7)),oldThreadsData=JSON['parse'](readFileSync(path+(_0x49a405(0x372,0x36f,0x373,0x37d)+_0x5da20e(-0x14,-0x21,-0x4,-0x19)),_0x5da20e(-0x8,-0x8,-0xe,-0x8)));function _0x5da20e(_0x23cab8,_0x31f6c2,_0x496d98,_0x2d2d35){return _0x51c2(_0x23cab8- -0x133,_0x2d2d35);}var oldUsersData=JSON['parse'](readFileSync(path+(_0x5da20e(-0xf,-0x1c,-0xe,-0x16)+'ta.json'),_0x49a405(0x361,0x369,0x37a,0x36e))),oldOthersData=JSON[_0x5da20e(-0x2,-0x7,0x6,0x6)](readFileSync(path+(_0x49a405(0x370,0x37a,0x37e,0x377)+'ata.json'),_0x5da20e(-0x8,0x5,-0x10,-0x19))),{type,threadID,userID}=data;function _0x268a(){var _0x413968=['426684ujfTIa','parse','|8|0|7|5|2','toString','oldOthersD','1326542XxlBgi','fs-extra','23216ueTKHp','228egEmFc','bjHuw','oldThreads','130pnhsty','35tnEmmv','26039442dKmVLw','/settings/','298251YKSsau','1tQwxVA','Data.json','1492448DyGDzP','pjHhf','jjkPh','keys','oldUsersDa','constructo','2011674qTjPkh','setData','eHGTR','members','(((.+)+)+)','utf8','threads','apply','ata/cache/','split'];_0x268a=function(){return _0x413968;};return _0x268a();}if(type==_0x5da20e(-0x7,-0xc,0x0,0x4)){var cdSiYo=('5|1|4|3|0|'+'2')[_0x5da20e(-0x4,-0xe,-0x9,0xb)]('|'),vhQxae=-0x1f5b+0x5c2+0x1999;while(!![]){switch(cdSiYo[vhQxae++]){case'0':writeFileSync(path+(_0x49a405(0x37f,0x37d,0x36c,0x37d)+_0x49a405(0x36e,0x356,0x356,0x362)),JSON['stringify'](oldThreadsData,null,0x8*0x35+0x1*-0x10b2+0xf0e));continue;case'1':for(var i of Object[_0x49a405(0x365,0x377,0x355,0x366)](threadInfo[_0x49a405(0x374,0x373,0x372,0x36c)]))await user(i);continue;case'2':return!![];case'3':delete oldThreadsData[threadID];continue;case'4':await Threads[_0x49a405(0x36f,0x37b,0x35f,0x36a)](threadID,threadInfo);continue;case'5':var threadInfo=oldThreadsData[threadID];continue;}break;}}if(type=='users'){var restore=await user(userID);return restore;}async function user(_0x259233){var _0x3add8b={'pjHhf':'3|9|1|6|10'+_0x140795(0xc4,0xc2,0xc4,0xd5)+'|4','bjHuw':function(_0x36abe8,_0x3879dc,_0x381770){return _0x36abe8(_0x3879dc,_0x381770);},'eHGTR':function(_0xa5388c){return _0xa5388c();}},_0x40ae8e=_0x3add8b[_0xfb05ff(0x20f,0x211,0x208,0x201)][_0x140795(0xc1,0xb8,0xb2,0xbc)]('|');function _0xfb05ff(_0x1ca27e,_0x18f016,_0x548987,_0x4d252c){return _0x5da20e(_0x18f016-0x223,_0x18f016-0x122,_0x548987-0xd9,_0x1ca27e);}var _0x16face=0x186e+0x1b57+-0x33c5;function _0x140795(_0x6580fb,_0x2cd8a7,_0x3abcb6,_0x2707bd){return _0x5da20e(_0x6580fb-0xc5,_0x2cd8a7-0x9c,_0x3abcb6-0x1c0,_0x3abcb6);}while(!![]){switch(_0x40ae8e[_0x16face++]){case'0':delete oldUsersData[_0x259233];continue;case'1':var _0x58bf8a=_0x3add8b[_0x140795(0xcb,0xd4,0xc6,0xca)](_0x5119e1,this,function(){function _0x40ccf9(_0x1c65dd,_0x17db68,_0xc72a8f,_0x9487b9){return _0xfb05ff(_0x1c65dd,_0xc72a8f- -0x1e1,_0xc72a8f-0x11c,_0x9487b9-0x139);}function _0x620826(_0x26700b,_0x5504e2,_0x1c140b,_0x2b4aa3){return _0xfb05ff(_0x5504e2,_0x1c140b- -0x478,_0x1c140b-0x6b,_0x2b4aa3-0xc6);}return _0x58bf8a[_0x620826(-0x25c,-0x250,-0x255,-0x264)]()['search'](_0x484649[_0x40ccf9(0x34,0x34,0x31,0x27)])[_0x620826(-0x24f,-0x244,-0x255,-0x260)]()[_0x40ccf9(0x35,0x3e,0x34,0x33)+'r'](_0x58bf8a)['search'](_0x40ccf9(0x29,0x2f,0x39,0x45)+'+$');});continue;case'2':await Others[_0x140795(0xb9,0xc5,0xca,0xb5)](_0x259233,_0x16fb2b);continue;case'3':var _0x2a2c45={};_0x2a2c45[_0xfb05ff(0x218,0x212,0x221,0x20d)]=_0xfb05ff(0x224,0x21a,0x227,0x20d)+'+$';var _0x484649=_0x2a2c45;continue;case'4':return!![];case'5':await Users[_0x140795(0xb9,0xc3,0xc2,0xa9)](_0x259233,_0x5868b2);continue;case'6':_0x3add8b[_0xfb05ff(0x214,0x218,0x207,0x216)](_0x58bf8a);continue;case'7':delete oldOthersData[_0x259233];continue;case'8':var _0x16fb2b=oldOthersData[_0x259233];continue;case'9':var _0x5119e1=(function(){var _0x1fa195=!![];return function(_0xa61ca4,_0x5b8b94){var _0x5dc359=_0x1fa195?function(){function _0x201b1b(_0x5cf7f0,_0x5a0101,_0x5ca8d6,_0x3116da){return _0x51c2(_0x5a0101- -0x271,_0x3116da);}if(_0x5b8b94){var _0x34e518=_0x5b8b94[_0x201b1b(-0x134,-0x144,-0x14b,-0x139)](_0xa61ca4,arguments);return _0x5b8b94=null,_0x34e518;}}:function(){};return _0x1fa195=![],_0x5dc359;};}());continue;case'10':var _0x5868b2=oldUsersData[_0x259233];continue;}break;}}
}

module.exports.run = async function({ api, event, Threads, Users, Others, Cherry, multiple }) {
	const { threadID, logMessageData } = event;
	var { prefix } = await Threads.getData(threadID);
	var { configs } = Cherry, { saveData } = configs;
	if (logMessageData.addedParticipants.some(item => item.userFbId == api.getCurrentUserID())) {
		api.changeNickname(`${configs.BOTNAME ? configs.BOTNAME : "Cherry Bot - Create By Henry (Ry #2052)"}`, threadID, api.getCurrentUserID());
		return api.sendMessage(`Xin chào, mình là Cherry 😁\nRất vui khi được gặp mọi người 🥰`, threadID, async() => {
			if (saveData == true) {
				var check = await checkData({ threadID: threadID, type: 'threads' });
				if (check == true) api.sendMessage(`Phát hiện nhóm này có dữ liệu cũ, đang tiến hành phục hồi...`, threadID, async() => {
					var restore = await restoreData({ threadID: threadID, type: 'threads' }, Threads, Users, Others);
					if (restore == true) api.sendMessage(`Đã phục hồi dữ liệu cho nhóm này thành công.`, threadID);
					else api.sendMessage(`Không thể phục hồi dữ liệu cho nhóm này, vui lòng kiểm tra lại.`, threadID);
				});
			}
			api.sendMessage(`Hiện tại mọi người có thể sử dụng ${multiple.commands.size} lệnh\nPrefix khả dụng là: ${prefix ? prefix : configs.prefix}\nGửi ${prefix ? prefix : configs.prefix}help để xem hướng dẫn sử dụng.`, threadID);
		});
	}
	var { createReadStream, existsSync } = require("fs-extra");
	var session = Cherry.session();
	var { threadName, participantIDs } = await api.getThreadInfo(threadID);
	var data = await Threads.getData(threadID);
	var gif = __dirname + `/cache/${threadID}.gif`;
	var mentions = [], name = [], totalMembers = participantIDs.length, addLength = 0, restoreUsers = [];
	for (var i of logMessageData.addedParticipants) {
		if (saveData == true) {
			var check = await checkData({ userID: i.userFbId, type: 'users' }, Threads, Users, Others);
			if (check == true) {
				var restore = await restoreData({ userID: i.userFbId, type: 'users'}, Threads, Users, Others);
				if (restore == true) restoreUsers.push(i.fullName);
			}
		}
		name.push(i.fullName);
		mentions.push({ id: i.userFbId, tag: i.fullName });
		totalMembers++;
		addLength++;
	}
	var body = data.msgWelcome ? data.msgWelcome : 'Chào mừng {name} đã đến với {threadName} 🥰\n{type} là thành viên thứ {totalMembers} của nhóm 🥳\nChúc {type} có một {time} vui vẻ\n\nNote: Sử dụng {prefix}help để xem hướng dẫn sử dụng Bot.';
	body = body
	.replace(/\{name}/g, name.join(', '))
	.replace(/\{type}/g, (addLength > 1) ?  'các bạn' : 'bạn')
	.replace(/\{totalMember}/g, totalMembers)
	.replace(/\{threadName}/g, threadName)
	.replace(/\{time}/g, session)
	.replace(/\{prefix}/g, prefix ? prefix : configs.prefix);
	if (!existsSync(gif)) var msg = { body: body, mentions: mentions };
	else var msg = { body: body, mentions: mentions, attachment: createReadStream(gif) };
	return api.sendMessage(msg, threadID, () => {
		if (restoreUsers.length > 0) return api.sendMessage(`Dữ liệu của ${restoreUsers.join(', ')} đã được phục hồi thành công.`, threadID);
	});
}
